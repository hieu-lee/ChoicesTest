@page "/exam-create/{ExamName}"
@page "/exam-create/{ExamName}/{TitleSeted:bool}/{Title}/{minutes:int}"
@using ChoicesTest.Models;
@using ChoicesTest.Components;
@using Microsoft.Data.Sqlite;
@inject IMatDialogService MatDialogService
@inject IJSRuntime JsRuntime
@inject NavigationManager navigationManager


@if (!TitleSeted)
{
    <h3>Set title for your new exam</h3>
    <MatTextField @bind-Value="Title" Label="Title" Required="true"></MatTextField>
    <br />
    <MatButton Unelevated="true" @onclick="SetTitle">Confirm</MatButton>
}


@if (TitleSeted)
{
    <h1>@Title</h1>
    <h5 style="text-align:center; display:@TimeDisplay;">Time limit: @minutes.ToString() minutes</h5>
    <ul>
        <Virtualize Items="questions" Context="ques">
            <li>
                <Question number="@ques.number" question="@ques.question" answerA="@ques.answerA" answerB="@ques.answerB" answerC="@ques.answerC" answerD="@ques.answerD">
                </Question>
            </li>
        </Virtualize>
    </ul>
    <hr />
    <div style="margin-bottom: 15px;">
        <MatTextField Type="number" TValue="int" @bind-Value="minutes" Label="Minutes"></MatTextField>
        <MatButton @onclick="SetTime" Unelevated="true" Style="margin-left: 10px;">Set time limit</MatButton>
    </div>
    <div>
        <MatTextField @bind-Value="NewTitle" Label="Question Title" TextArea="true" Style="width:478px; resize:vertical; height: 55px"></MatTextField>
        <div class="new-answers" style="margin-top: 10px;">
            <MatRadioGroup @bind-Value="@Answer" TValue="string">
                <MatRadioButton Value="@("A")" TValue="string"></MatRadioButton><MatTextField @bind-Value="NewAnswerA" TextArea="true" Label="Answer A" Style="width: 438px; resize: vertical; height: 55px"></MatTextField><br />
                <MatRadioButton Value="@("B")" TValue="string"></MatRadioButton><MatTextField @bind-Value="NewAnswerB" TextArea="true" Label="Answer B" Style="width: 438px; resize: vertical; height: 55px"></MatTextField><br />
                <MatRadioButton Value="@("C")" TValue="string"></MatRadioButton><MatTextField @bind-Value="NewAnswerC" TextArea="true" Label="Answer C" Style="width: 438px; resize: vertical; height: 55px"></MatTextField><br />
                <MatRadioButton Value="@("D")" TValue="string"></MatRadioButton><MatTextField @bind-Value="NewAnswerD" TextArea="true" Label="Answer D" Style="width: 438px; resize: vertical; height: 55px"></MatTextField><br />
            </MatRadioGroup>
        </div>
    </div>
    <div style="margin-bottom:20px; margin-top: 10px;">
        <MatButton Unelevated="true" @onclick="CreateNewQuestion">Add Question</MatButton>
        <MatButton @onclick="DeleteExam" Style="margin-left: 10px;">Delete</MatButton>
    </div>
}


@code {
    [Parameter]
    public string ExamName { get; set; } = "exam";

    [Parameter]
    public bool TitleSeted { get; set; } = false;

    [Parameter]
    public string Title { get; set; } = string.Empty;

    [Parameter]
    public int minutes { get; set; } = 0;

    private int prevTimeLimit = 0;
    private string TimeDisplay = "none";
    private SqliteConnection connection;
    private string NewTitle = string.Empty;
    private string NewAnswerA = string.Empty;
    private string NewAnswerB = string.Empty;
    private string NewAnswerC = string.Empty;
    private string NewAnswerD = string.Empty;
    private string Answer;
    private List<QuestionInfo> questions = new List<QuestionInfo>();
    private int CurrentQuestionNumber = 1;

    protected override async Task OnInitializedAsync()
    {
        var connectionStringBuilder = new SqliteConnectionStringBuilder();
        connectionStringBuilder.DataSource = "exams.db";
        connection = new SqliteConnection(connectionStringBuilder.ConnectionString);
        if (TitleSeted)
        {
            await LoadQuestion();
        }
        SetTime();
    }

    private async Task LoadQuestion()
    {
        var task = connection.OpenAsync();
        var myCmd = connection.CreateCommand();
        try
        {
            myCmd.CommandText = $"SELECT * FROM {ExamName}";
            await task;
            using var rdr = myCmd.ExecuteReader();
            while (rdr.Read())
            {
                questions.Add(new QuestionInfo() { number = rdr.GetInt32(0), question = rdr.GetString(1), answerA = rdr.GetString(2), answerB = rdr.GetString(3), answerC = rdr.GetString(4), answerD = rdr.GetString(5), answer = rdr.GetString(6) });
                CurrentQuestionNumber++;
            }
        }
        catch (Exception) { };
        connection.Close();
    }

    private async Task CreateNewDb()
    {
        var task = connection.OpenAsync();
        var tablecmd = connection.CreateCommand();
        var cmd = connection.CreateCommand();
        cmd.CommandText = $"INSERT INTO exam_collection(code, name, time) VALUES('{ExamName}', '{Title}', 0);";
        tablecmd.CommandText = $"CREATE TABLE {ExamName}(id INTEGER PRIMARY KEY, title TEXT, answer_a TEXT, answer_b TEXT, answer_c TEXT, answer_d TEXT, answer TEXT);";
        await task;
        cmd.ExecuteNonQuery();
        tablecmd.ExecuteNonQuery();
        connection.Close();
    }

    private async void SetTitle()
    {
        if (string.IsNullOrWhiteSpace(Title))
        {
            await JsRuntime.InvokeAsync<object>("alert", "Please set a title for your new exam.");
            return;
        }
        else
        {
            Title.Trim();
            Title = Title.First().ToString().ToUpper() + Title.Substring(1);
            TitleSeted = true;
            await CreateNewDb();
            StateHasChanged();
        }
    }

    private async Task InsertQuestionAsync(QuestionInfo info)
    {
        var task = connection.OpenAsync();
        var insertCmd = connection.CreateCommand();
        insertCmd.CommandText = $"INSERT INTO {ExamName}(id, title, answer_a, answer_b, answer_c, answer_d, answer) VALUES({info.number},'{info.question}', '{info.answerA}', '{info.answerB}', '{info.answerC}', '{info.answerD}', '{info.answer}')";
        await task;
        insertCmd.ExecuteNonQuery();
        connection.Close();
    }

    private async void DeleteExam()
    {
        var task = connection.OpenAsync();
        var tablecmd = connection.CreateCommand();
        tablecmd.CommandText = $"DROP TABLE {ExamName}";
        await task;
        tablecmd.ExecuteNonQuery();
        await JsRuntime.InvokeAsync<object>("alert", "Successfully deleted the exam.");
        navigationManager.NavigateTo($"/removed/{ExamName}");
    }

    private async void SetTime()
    {
        if (minutes > 0 && minutes != prevTimeLimit)
        {
            var task = connection.OpenAsync();
            var cmd = connection.CreateCommand();
            cmd.CommandText = $"UPDATE exam_collection SET time = {minutes} WHERE code = '{ExamName}';";
            await task;
            cmd.ExecuteNonQuery();
            connection.Close();
            TimeDisplay = "block";
            prevTimeLimit = minutes;
            return;
        }
        else if (minutes == 0 && minutes != prevTimeLimit)
        {
            var task = connection.OpenAsync();
            var cmd = connection.CreateCommand();
            cmd.CommandText = $"UPDATE exam_collection SET time = 0 WHERE code = '{ExamName}';";
            await task;
            cmd.ExecuteNonQuery();
            connection.Close();
            TimeDisplay = "none";
            prevTimeLimit = 0;
            return;
        }
        else
        {
            TimeDisplay = "none";
            minutes = 0;
            prevTimeLimit = 0;
            return;
        }
    }

    private async void CreateNewQuestion()
    {
        if (CurrentQuestionNumber == 100)
        {
            await JsRuntime.InvokeAsync<object>("alert", "You have reached the maximum number of questions for this exam!");
            return;
        }
        if (!string.IsNullOrWhiteSpace(NewTitle) && !string.IsNullOrWhiteSpace(NewAnswerA) && !string.IsNullOrWhiteSpace(NewAnswerB) && !string.IsNullOrWhiteSpace(NewAnswerC) && !string.IsNullOrWhiteSpace(NewAnswerD))
        {
            if (NewTitle.Contains('\'') || NewAnswerA.Contains('\'') || NewAnswerB.Contains('\'') || NewAnswerC.Contains('\'') || NewAnswerD.Contains('\''))
            {
                await JsRuntime.InvokeAsync<object>("alert", "The question must not contain special characters");
                return;
            }
            if (!string.IsNullOrWhiteSpace(Answer))
            {
                var Answers = new HashSet<string>();
                NewTitle.Trim();
                NewAnswerA.Trim();
                NewAnswerB.Trim();
                NewAnswerC.Trim();
                NewAnswerD.Trim();
                Answers.Add(NewAnswerA);
                Answers.Add(NewAnswerB);
                Answers.Add(NewAnswerC);
                Answers.Add(NewAnswerD);
                if (Answers.Count < 4)
                {
                    await JsRuntime.InvokeAsync<object>("alert", "Your given answers must be different from each other.");
                    return;
                }
                if (NewTitle.Last() != '?')
                {
                    NewTitle += "?";
                }
                NewTitle = NewTitle.First().ToString().ToUpper() + NewTitle.Substring(1);
                var NewQuestion = new QuestionInfo() { question = NewTitle, number = CurrentQuestionNumber, answerA = NewAnswerA, answerB = NewAnswerB, answerC = NewAnswerC, answerD = NewAnswerD, answer = Answer };
                var task1 = InsertQuestionAsync(NewQuestion);
                questions.Add(NewQuestion);
                NewTitle = string.Empty;
                NewAnswerA = string.Empty;
                NewAnswerB = string.Empty;
                NewAnswerC = string.Empty;
                NewAnswerD = string.Empty;
                Answer = string.Empty;
                CurrentQuestionNumber++;
                StateHasChanged();
                await task1;
            }
            else
            {
                await JsRuntime.InvokeAsync<object>("alert", "Please choose a correct answer to the question.");
                return;
            }
        }
        else
        {
            await JsRuntime.InvokeAsync<object>("alert", "Please fill in all parts of the new question.");
            return;
        }
    }
}
