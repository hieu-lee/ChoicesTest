@page "/do-exam/{ExamCode}/{ExamName}"
@using ChoicesTest.Components;
@using ChoicesTest.Models;
@using Microsoft.Data.Sqlite;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@inject IJSRuntime JsRuntime
@inject NavigationManager navigationManager
@inject ProtectedSessionStorage sessionStorage

<h1>@ExamName</h1>
<ul>
    @foreach (QuestionInfo ques in questions)
    {
        <li>
            <Question personalWork="@personalWork" number="@ques.number" question="@ques.question" answerA="@ques.answerA" answerB="@ques.answerB" answerC="@ques.answerC" answerD="@ques.answerD">
            </Question>
        </li>
    }
</ul>
<hr />
<div class="button-holder">
    <button class="btn btn-primary" @onclick="ShowScore">Submit</button>
</div>

@code {
    [Parameter]
    public string ExamCode { get; set; }
    [Parameter]
    public string ExamName { get; set; }
    private string user;
    public Dictionary<int, char> personalWork = new Dictionary<int, char>();
    private Dictionary<int, char> solutionKey = new Dictionary<int, char>();
    private List<QuestionInfo> questions = new List<QuestionInfo>();
    private SqliteConnection connection;

    protected override async Task<Task> OnInitializedAsync()
    {
        await LoadExam();
        return base.OnInitializedAsync();
    }

    private async Task LoadUser()
    {
        var result = await sessionStorage.GetAsync<string>("account");
        if (result.Success)
        {
            user = result.Value;
        }
    }

    private async Task LoadExam()
    {
        var connectionStringBuilder = new SqliteConnectionStringBuilder();
        connectionStringBuilder.DataSource = "exams.db";
        connection = new SqliteConnection(connectionStringBuilder.ConnectionString);
        var task = connection.OpenAsync();
        var myCmd = connection.CreateCommand();
        await task;
        try
        {
            myCmd.CommandText = $"SELECT * FROM {ExamCode}";
            using var rdr = myCmd.ExecuteReader();
            while (rdr.Read())
            {
                solutionKey.Add(rdr.GetInt32(0), rdr.GetChar(6));
                questions.Add(new QuestionInfo() { number = rdr.GetInt32(0), question = rdr.GetString(1), answerA = rdr.GetString(2), answerB = rdr.GetString(3), answerC = rdr.GetString(4), answerD = rdr.GetString(5), answer = rdr.GetString(6) });
            }
        }
        catch (Exception) { };
        connection.Close();
    }

    private async void ShowScore()
    {
        var task = LoadUser();
        var score = 0;
        var max = 0;
        Parallel.ForEach(solutionKey.Keys, qnum =>
        {
            max++;
            try
            {
                if (solutionKey[qnum] == personalWork[qnum])
                {
                    score++;
                }
            }
            catch (Exception) { }
        });
        var percent = Convert.ToDouble(score) / Convert.ToDouble(max);
        percent *= 100.0;
        var res = Math.Round(percent, 2);
        var task2 = JsRuntime.InvokeAsync<object>("alert", $"You got {score.ToString()}/{max.ToString()} answers correct, and a result of {res.ToString()}%");
        await task;
        var task3 = connection.OpenAsync();
        var myCmd = connection.CreateCommand();
        myCmd.CommandText = $"INSERT INTO {user}(exam, score, time) VALUES('{ExamCode}', {res}, '{DateTime.Now.ToString()}')";
        await task3;
        myCmd.ExecuteNonQuery();
        connection.Close();
        navigationManager.NavigateTo("/true");
    }
}
